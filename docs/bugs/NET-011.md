# NET-011: Int64 to Enum Conversion Fails with InvalidCastException

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ Open |
| **Severity** | ðŸ”´ High |
| **Product** | DataLinq.NET |
| **Component** | `ObjectMaterializer` |
| **Discovered** | 2026-02-14 |

## Summary
`ObjectMaterializer` throws `InvalidCastException` when a database returns integer enum values as `Int64` (which Snowflake, Postgres, and many databases do). The compiled factory delegate uses `Expression.Convert` to unbox values, which requires an exact type match â€” unboxing an `Int64` to `DayOfWeek` (backed by `Int32`) fails.

## Impact
**High** â€” Any enum column from a database that returns `Int64` integers will crash. This is the default numeric type for Snowflake and many other databases.

## Root Cause
Three locations lack enum-aware conversion:
1. `CompileFactoryDelegate()` â€” emits `Expression.Convert(indexExpr, paramType)` which does a direct unbox. `Int64` â†’ enum unbox fails.
2. `CtorMaterializationSession.Create()` â€” passes raw `values[idx]` without pre-converting for enum params.
3. `CreateViaPrimaryConstructorWithSchema()` â€” same issue on the cold path.

Fix: Pre-convert using `Enum.ToObject(targetType, value)` or `Convert.ChangeType()` before the value reaches the expression tree delegate.

## Tests
- `Create_WithInt64ForEnum_ShouldConvertCorrectly`
- `CreateCtorSession_WithInt64ForEnum_ShouldConvertCorrectly`
- `CreateGeneralSession_WithInt64ForEnum_ShouldConvertCorrectly`
